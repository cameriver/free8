# Free Eight 実装計画書（作成モデル: GPT-5.1）

- 文書名: Free Eight 実装計画書
- 対象アプリ: オンラインマルチプレイヤーカードゲーム「Free Eight」
- 作成モデル: GPT-5.1（OpenAI）
- 想定読者: 開発に協力するエンジニア / 将来の自分
- バージョン: v1.0
- 作成日: 2025-12-01

---

## 1. 背景と目的

- 現在:
  - Node.js + Express + Socket.IO で動くオンライン対戦カードゲーム。
  - ゲーム状態はサーバーのメモリ上のみ（サーバー再起動で消える）。
  - ユーザーアカウント機能やスコアの永続保存はない。
- 目的:
  - 将来、複数人のプレイヤーが「サービスにアカウント登録」してプレイできるようにする。
  - ユーザーごとのスコア・対戦履歴をデータベースに永続保存する。
  - 非エンジニアでも段階を追って進められる実装ロードマップを用意する。

---

## 2. スコープと前提

### 2.1 この計画でやること

- 小さく始めて、後から拡張しやすい構成を準備する。
- 想定規模: 同時接続〜数十〜数百人程度（コミュニティ向けサービス）。
- 段階的に以下を追加:
  1. 安定したホスティング（Railway 等）へのデプロイ
  2. PostgreSQL によるユーザー・対戦履歴の保存
  3. シンプルなユーザー登録・ログイン（メール + パスワード）

### 2.2 この計画でやらないこと（将来候補）

- 複数サーバー構成（ロードバランサー、Redis クラスタなど）の詳細設計
- マイクロサービス化
- GDPR など厳密な法令対応の細部
- 高度なチート対策（まずは基本的な不正防止のみ）

---

## 3. 推奨アーキテクチャ概要

### 3.1 ホスティング方針

- 本計画では、既存の `MIGRATION_PLAN.md` と整合するように **Railway + PostgreSQL** を前提とする。
- 代替案（必要に応じてエンジニアと相談）:
  - Render + PostgreSQL（無料枠重視・お試し向け）
  - Heroku + Heroku Postgres（すでに慣れている場合）

### 3.2 アプリ構成とディレクトリ

将来の認証・DB 導入を見据えたシンプルな構成イメージ:

```text
Free Eight/
├── package.json
├── src/
│   ├── server.js           # 起動と Express / Socket.IO 初期化
│   ├── config/
│   │   └── env.js          # 環境変数の読み込み（PORT, DATABASE_URL など）
│   ├── sockets/
│   │   └── gameSocket.js   # ゲーム用 Socket.IO ロジック
│   ├── routes/
│   │   ├── healthcheck.js  # 動作確認用
│   │   └── authRoutes.js   # /api/auth/*（フェーズ3で追加）
│   ├── services/
│   │   ├── userService.js  # ユーザー作成・認証ロジック
│   │   └── gameService.js  # スコア計算など
│   └── repositories/
│       ├── userRepository.js
│       └── gameRepository.js
└── public/
    ├── index.html
    ├── standalone.html
    └── assets/
        └── app.js          # フロント JS（徐々にここへ移動）
```

---

## 4. 実装フェーズ

### フェーズ 0: 現状のまま Railway にデプロイ

**目的:** コード変更を最小限にして、今のゲームを Railway 上で安定して動かす。

- 主な作業:
  - Railway アカウント作成・GitHub リポジトリ接続。
  - `PORT` などの環境変数を Railway に設定。
  - 現在の `server.js` + `public/` 構成のままデプロイ。
- 完了条件:
  - [ ] Railway 上の URL からゲーム画面にアクセスできる。
  - [ ] 複数ブラウザ / 端末から同じルームに入り、対戦できる。
  - [ ] ログに Socket.IO のエラーが出ていない。

---

### フェーズ 1: ディレクトリ構造の整理

**目的:** 役割ごとにコードを分け、機能追加しやすい形にする。

- 主な作業:
  - `src/` フォルダを作成し、`src/server.js` からアプリを起動する形に変更。
  - ゲームロジック（ルーム管理・ターン処理など）を `src/sockets/gameSocket.js` に切り出す。
  - 簡単な `GET /health` のような API を `src/routes/healthcheck.js` に定義。
  - フロントエンド JS を `public/assets/app.js` などに移し始める。
- 完了条件:
  - [ ] ローカルと Railway の両方で、整理後の構成でゲームが問題なく動く。
  - [ ] ゲーム関連の Socket.IO ロジックが `sockets/` にまとまっている。
  - [ ] 将来の `routes/authRoutes.js` などを追加しやすい雰囲気になっている。

---

### フェーズ 2: PostgreSQL 導入と基本テーブル作成

**目的:** ユーザー・対戦履歴を DB に保存できる基盤を作る。

- 主な作業（エンジニア担当想定）:
  - Railway で PostgreSQL インスタンスを作成し、`DATABASE_URL` を設定。
  - ORM として Prisma を使うか、`pg` を直接使うか決定。
  - 最小スキーマの設計・マイグレーション:

    例（概念レベル）:
    - `users`: メール、パスワードハッシュ、表示名、累計スコアなど
    - `game_history`: ルーム ID、開始/終了時刻、勝者、勝ち方（ツモ/ロンなど）
    - （余力があれば `game_participants` テーブルで参加者ごとのスコアも管理）

  - `src/repositories/userRepository.js` と `gameRepository.js` を作成し、
    DB アクセスを 1 カ所に集約。
- 完了条件:
  - [ ] 本番環境から DB に接続できる（簡単な SELECT / INSERT が成功する）。
  - [ ] ユーザーを 1 件手動で登録し、アプリから参照できる。
  - [ ] 対戦終了時に、最低限の情報が `game_history` に保存される。

---

### フェーズ 3: ユーザー登録・ログイン機能の追加

**目的:** プレイヤーがアカウントを作り、自分の名前でログインして遊べるようにする。

- 主な API（最初の一歩）:
  - `POST /api/auth/register` – メール + パスワードで新規登録
  - `POST /api/auth/login` – ログイン（トークン or セッション発行）
  - `GET /api/auth/me` – 現在ログイン中のユーザー情報を返す
- 実装の方向性:
  - パスワードは `bcrypt` などでハッシュ化して保存（生パスワードは保存しない）。
  - ログイン成功時に JWT またはセッション Cookie を発行。
  - Socket.IO 接続時に、そのトークン / セッション情報を渡し、
    サーバー側で `socket.userId` として扱えるようにする。
  - 既存のゲスト ID（LocalStorage の clientId）は、しばらく併用して壊さない。
- 完了条件:
  - [ ] 新規登録 → ログイン → ゲーム入室 の一連の流れが動く。
  - [ ] 同じアカウントで再ログインすると、同じユーザーとして扱われる。
  - [ ] ゲストプレイも引き続き可能である。

---

## 5. レビュー観点（チェックリスト）

### 5.1 プレイヤー体験

- [ ] ログインしなくても「お試しプレイ」ができる。
- [ ] ログイン済みユーザーには、名前やスコアが分かりやすく表示される。
- [ ] ユーザー登録フォームがシンプルで、入力項目が多すぎない。

### 5.2 技術的安全性・拡張性

- [ ] パスワードはハッシュ化されており、生パスワードが DB に保存されていない。
- [ ] DB スキーマが、ランキングやフレンド機能など将来の拡張を大きく邪魔しない。
- [ ] ゲームロジック・API・DB アクセスがディレクトリごとに分かれ、読めば役割が分かる。

### 5.3 コストと運用

- [ ] Railway の料金プランが、想定ユーザー数に対して現実的である。
- [ ] PostgreSQL のバックアップ・復元手順がおおまかに決まっている。
- [ ] 障害時に「一時的にインメモリモードで運用する」などの簡易プランがある。

---

## 6. 今後の拡張アイデア（本計画の外）

- ランキング機能（累計スコアや直近の成績で順位付け）。
- フレンド機能・招待リンク。
- 観戦モード・リプレイ機能。
- メール通知（フレンドがオンラインになったときなど）。
- モバイル端末向け UI 調整。

---

## 7. メタ情報

- 本実装計画書は、モデル **GPT-5.1** が
  `README.md` と `MIGRATION_PLAN.md` を元に作成した。
- 実装が進んだら、このファイルに「実際にやったこと」「問題になった点」「回避策」などを追記して、
  将来の自分や協力してくれるエンジニアへの共有資料として育てていく想定。


