<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Free Eight - Online</title>
<style>
/* ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
* { box-sizing: border-box; }
body {
  font-family: 'Segoe UI', 'Hiragino Sans', sans-serif;
  background: linear-gradient(135deg, #0c1a2b 0%, #1a2a4a 100%);
  color: #e0e6f0;
  text-align: center;
  padding: 20px;
  min-height: 100vh;
  margin: 0;
}

h1 {
  margin-bottom: 10px;
  font-size: 2.5em;
  text-shadow: 0 2px 10px rgba(74,163,255,0.3);
}

.muted { opacity: .8; font-size: .9em; }

/* ãƒ‘ãƒãƒ« */
.panel {
  background: linear-gradient(145deg, #14233b 0%, #1b2e50 100%);
  border: 1px solid #2c3f5f;
  border-radius: 12px;
  padding: 15px;
  margin: 12px auto;
  max-width: 980px;
  transition: all 0.3s ease;
}

/* ãƒœã‚¿ãƒ³ */
button {
  margin: 5px;
  padding: 10px 18px;
  border-radius: 8px;
  background: linear-gradient(145deg, #1b2e50 0%, #2a4070 100%);
  color: #fff;
  border: 1px solid #445;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
}
button:hover {
  background: linear-gradient(145deg, #2a4070 0%, #3a5090 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(74,163,255,0.3);
}
button:active {
  transform: translateY(0);
}
button[disabled] {
  opacity: .5;
  cursor: not-allowed;
  transform: none;
}

/* ã‚¤ãƒ³ãƒ—ãƒƒãƒˆ */
input {
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid #445;
  background: #0f1c2c;
  color: #e0e6f0;
  margin: 0 4px;
  font-size: 14px;
}
input:focus {
  outline: none;
  border-color: #4aa3ff;
  box-shadow: 0 0 8px rgba(74,163,255,0.3);
}

/* ã‚«ãƒ¼ãƒ‰ */
.card {
  display: inline-block;
  margin: 4px;
  padding: 12px 16px;
  border-radius: 10px;
  background: linear-gradient(145deg, #fff 0%, #f0f0f0 100%);
  color: #000;
  min-width: 50px;
  font-size: 18px;
  font-weight: bold;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2), 0 4px 12px rgba(0,0,0,0.1);
  transition: all 0.2s ease;
  user-select: none;
}
.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.3);
}
.card.puttable {
  box-shadow: 0 0 15px 5px rgba(122, 224, 184, 0.6), 0 2px 6px rgba(0,0,0,0.2);
  cursor: pointer;
  animation: cardPulse 1.5s ease-in-out infinite;
}
.card.puttable:hover {
  transform: translateY(-8px) scale(1.05);
  box-shadow: 0 0 20px 8px rgba(122, 224, 184, 0.8), 0 8px 20px rgba(0,0,0,0.3);
}
@keyframes cardPulse {
  0%, 100% { box-shadow: 0 0 15px 5px rgba(122, 224, 184, 0.5); }
  50% { box-shadow: 0 0 20px 8px rgba(122, 224, 184, 0.8); }
}

/* ç‰¹æ®Šã‚«ãƒ¼ãƒ‰ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
.card.special-2 { border: 2px solid #ff6b6b; }
.card.special-qs { border: 2px solid #9b59b6; }
.card.special-57 { border: 2px solid #f39c12; }
.card.special-8 { border: 2px solid #3498db; }

.card-back {
  display: inline-block;
  padding: 12px 16px;
  background: linear-gradient(145deg, #2a3a5a 0%, #1a2a4a 100%);
  color: #8899bb;
  border-radius: 10px;
  font-size: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

.suit-red { color: #d1182a; }
.suit-black { color: #1a1a2e; }

/* ã‚¿ãƒ¼ãƒ³è¡¨ç¤º */
.turn-hot {
  background: linear-gradient(145deg, #1a3a2a 0%, #2a5a4a 100%) !important;
  border: 2px solid #4ade80 !important;
  box-shadow: 0 0 20px rgba(74, 222, 128, 0.4), 0 0 40px rgba(74, 222, 128, 0.2);
  animation: turnGlow 2s ease-in-out infinite;
}
@keyframes turnGlow {
  0%, 100% { box-shadow: 0 0 20px rgba(74, 222, 128, 0.4); }
  50% { box-shadow: 0 0 30px rgba(74, 222, 128, 0.6), 0 0 50px rgba(74, 222, 128, 0.3); }
}

/* ã‚¿ãƒ¼ãƒ³ãƒãƒŠãƒ¼ */
.turn-banner {
  display: none;
  background: linear-gradient(90deg, #10b981 0%, #34d399 50%, #10b981 100%);
  background-size: 200% 100%;
  color: #fff;
  font-weight: bold;
  font-size: 16px;
  padding: 8px 20px;
  border-radius: 20px;
  margin-bottom: 10px;
  animation: bannerSlide 2s linear infinite, bannerPop 0.5s ease-out;
  box-shadow: 0 4px 15px rgba(16, 185, 129, 0.5);
}
.turn-banner.active {
  display: inline-block;
}
@keyframes bannerSlide {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
@keyframes bannerPop {
  0% { transform: scale(0.8); opacity: 0; }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); opacity: 1; }
}

/* ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³è¡¨ç¤º */
.opponent-turn-indicator {
  display: none;
  background: #f59e0b;
  color: #fff;
  font-size: 12px;
  padding: 4px 12px;
  border-radius: 12px;
  margin-left: 8px;
  animation: pulse 1s ease-in-out infinite;
}
.opponent-turn-indicator.active {
  display: inline-block;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

/* æ”»æ’ƒè¡¨ç¤º */
.attack-field {
  display: inline-block;
  background: linear-gradient(90deg, #dc2626 0%, #ef4444 100%);
  color: #fff;
  font-weight: bold;
  padding: 8px 16px;
  border-radius: 8px;
  margin-left: 10px;
  animation: attackPulse .6s ease-in-out infinite alternate;
  font-size: 16px;
}
.attack-field.qs-attack {
  background: linear-gradient(90deg, #7c3aed 0%, #a78bfa 100%);
}
@keyframes attackPulse {
  from { transform: scale(1); box-shadow: 0 0 10px rgba(220, 38, 38, 0.5); }
  to { transform: scale(1.05); box-shadow: 0 0 20px rgba(220, 38, 38, 0.8); }
}

/* ãƒãƒ¼ã‚¯é¸æŠ */
.suit-select {
  margin-top: 15px;
  padding: 15px;
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
  animation: flash 1s ease-in-out infinite alternate;
}
.suit-btn {
  margin: 8px;
  padding: 15px 24px;
  border-radius: 12px;
  border: 2px solid #999;
  cursor: pointer;
  font-size: 28px;
  transition: all 0.2s ease;
}
.suit-btn:hover {
  transform: scale(1.1);
}
.suit-btn.red {
  color: #d1182a;
  background: linear-gradient(145deg, #fff0f0 0%, #ffe0e0 100%);
  border-color: #f99;
}
.suit-btn.black {
  color: #1a1a2e;
  background: linear-gradient(145deg, #f5f5f5 0%, #e5e5e5 100%);
  border-color: #ccc;
}

/* ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ */
.scoreboard {
  background: linear-gradient(145deg, #11263a 0%, #1a3050 100%);
  border-radius: 12px;
  padding: 15px;
  margin: 15px auto;
  max-width: 980px;
}
.ranktable {
  margin: auto;
  border-collapse: collapse;
  color: #fff;
  width: 90%;
}
.ranktable td, .ranktable th {
  border-bottom: 1px solid #335;
  padding: 10px 12px;
}
.ranktable th {
  background: #1b2e50;
}
.ranktable tr:hover td {
  background: rgba(74,163,255,0.1);
}

/* å‹è€…è¡¨ç¤º */
.winner {
  background: linear-gradient(145deg, #103020 0%, #1a4a30 100%);
  border: 2px solid #4ade80;
  color: #9f9;
  padding: 15px;
  margin: 15px auto;
  border-radius: 12px;
  max-width: 980px;
}

/* æ‰‹æœ­é–‹ç¤º */
.reveal {
  background: linear-gradient(145deg, #0f2136 0%, #1a3050 100%);
  border: 1px solid #2b4770;
  border-radius: 12px;
  padding: 15px;
  margin: 15px auto;
  max-width: 980px;
  text-align: left;
}
.reveal h3 {
  margin: 8px 0;
  font-size: 16px;
  color: #bfe0ff;
}
.reveal .row {
  margin: 8px 0;
  padding: 10px;
  background: rgba(0,0,0,0.2);
  border-radius: 8px;
}

@keyframes flash {
  from { opacity: 0.7; transform: scale(1); }
  to { opacity: 1; transform: scale(1.02); }
}

/* RON ãƒ¢ãƒ¼ãƒ€ãƒ« */
#ronModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  backdrop-filter: blur(4px);
}
#ronBox {
  background: linear-gradient(145deg, #0f2136 0%, #1a3050 100%);
  border: 2px solid #ff6b6b;
  border-radius: 16px;
  padding: 25px;
  max-width: 520px;
  width: 92%;
  box-shadow: 0 20px 50px rgba(0,0,0,0.5);
  animation: ronBoxPop 0.3s ease-out;
}
@keyframes ronBoxPop {
  from { transform: scale(0.8); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
#ronBox h3 {
  margin: 0 0 12px;
  font-size: 28px;
  color: #ff6b6b;
  text-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
}

/* çµ‚å±€ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
#resultOverlay {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9998;
  background: rgba(0,0,0,.75);
  backdrop-filter: blur(6px);
}
#resultCard {
  background: linear-gradient(145deg, #0f2136 0%, #1a3050 100%);
  border: 3px solid #4aa3ff;
  border-radius: 20px;
  padding: 30px;
  max-width: 760px;
  width: 92%;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  transform: scale(.9);
  opacity: 0;
  animation: popIn .4s ease-out forwards;
}
#resultTitle {
  font-size: 48px;
  letter-spacing: .15em;
  margin: 0 0 12px;
  text-shadow: 0 4px 20px rgba(74,163,255,0.5);
}
#resultSub {
  font-size: 18px;
  color: #cde6ff;
  margin: 0 0 20px;
}
#resultTable {
  margin: 15px auto 0;
  text-align: left;
  max-height: 60vh;
  overflow: auto;
}
#resultTable h3 {
  margin: 12px 0 8px;
  color: #bfe0ff;
}
#resultClose {
  margin-top: 20px;
  padding: 12px 30px;
  font-size: 16px;
}
@keyframes popIn {
  to { transform: scale(1); opacity: 1; }
}

/* ãƒ„ãƒ¢ï¼šé’ */
.title-tsumo {
  color: #4aa3ff;
  text-shadow: 0 0 15px rgba(74,163,255,.7), 0 0 30px rgba(74,163,255,.4);
  animation: tsumoPop .6s ease-out;
}
@keyframes tsumoPop {
  0% { transform: scale(.8); opacity: .3; }
  60% { transform: scale(1.08); opacity: 1; }
  100% { transform: scale(1); }
}

/* ãƒ­ãƒ³ï¼šèµ¤ */
.title-ron {
  color: #ff4a4a;
  text-shadow: 0 0 15px rgba(255,74,74,.6), 0 0 30px rgba(255,74,74,.3);
  animation: ronShake .4s ease-in-out, ronPulse 1.2s ease-in-out .4s infinite;
}
@keyframes ronShake {
  0%,100% { transform: translateX(0); }
  20% { transform: translateX(-8px); }
  40% { transform: translateX(6px); }
  60% { transform: translateX(-4px); }
  80% { transform: translateX(2px); }
}
@keyframes ronPulse {
  0%,100% { text-shadow: 0 0 10px rgba(255,74,74,.5); }
  50% { text-shadow: 0 0 25px rgba(255,74,74,.9); }
}

/* ãƒ­ãƒ³è¿”ã— */
.title-ronrev {
  color: #ffd94a;
  letter-spacing: .1em;
  text-shadow: 0 0 15px rgba(255,217,74,.8), 0 0 35px rgba(255,255,255,.4);
  animation: ronrevBoom .5s ease-out;
}
@keyframes ronrevBoom {
  0% { transform: scale(.6); filter: brightness(1.3); opacity: .3; }
  60% { transform: scale(1.1); filter: brightness(1.8); opacity: 1; }
  100% { transform: scale(1); filter: brightness(1); }
}

/* å±±æœ­åˆ‡ã‚Œ */
.title-draw {
  color: #94a3b8;
  text-shadow: 0 0 10px rgba(148,163,184,.5);
}

/* é›·FX */
#thunderFX {
  position: absolute;
  inset: 0;
  pointer-events: none;
  display: none;
}
.thunder-flash {
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at center, rgba(255,255,255,.8), rgba(255,255,255,0) 60%);
  animation: flashBlink .25s ease-out;
}
@keyframes flashBlink {
  0% { opacity: 0; }
  30% { opacity: 1; }
  100% { opacity: 0; }
}
.bolt {
  position: absolute;
  width: 10px;
  height: 40vh;
  background: linear-gradient(#fff, #ffe36a);
  filter: drop-shadow(0 0 10px #fff) drop-shadow(0 0 18px #ffe36a);
  clip-path: polygon(40% 0, 60% 0, 52% 18%, 70% 18%, 34% 60%, 54% 60%, 30% 100%, 10% 100%, 28% 66%, 8% 66%, 44% 24%, 26% 24%);
  opacity: 0;
  animation: boltStrike .4s ease-out forwards;
}
.bolt.b2 { left: 68%; top: -8vh; transform: rotate(6deg); animation-delay: .08s; }
.bolt.b1 { left: 28%; top: -6vh; transform: rotate(-4deg); }
@keyframes boltStrike {
  0% { opacity: 0; transform: translateY(-12vh) scaleY(.8); }
  20% { opacity: 1; }
  100% { opacity: 0; transform: translateY(12vh) scaleY(1); }
}

/* å±±æœ­è¡¨ç¤º */
#deckInfo {
  font-size: 18px;
  margin: 10px 0;
  padding: 8px 16px;
  background: rgba(0,0,0,0.3);
  border-radius: 8px;
  display: inline-block;
}

/* å ´ã®ã‚«ãƒ¼ãƒ‰ */
.field-card {
  display: inline-block;
  padding: 20px 28px;
  font-size: 28px;
  font-weight: bold;
  background: linear-gradient(145deg, #fff 0%, #f0f0f0 100%);
  border-radius: 14px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3), 0 0 30px rgba(74,163,255,0.2);
}

/* ç‚¹æ•°å†…è¨³ */
.point-breakdown {
  background: rgba(0,0,0,0.2);
  border-radius: 8px;
  padding: 12px;
  margin: 10px 0;
  font-size: 14px;
}
.point-breakdown .formula {
  color: #ffd166;
  font-weight: bold;
}
</style>
</head>
<body>
<h1>ğŸƒ Free Eight</h1>
<p class="muted">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤å¯¾æˆ¦ (2ãƒ‡ãƒƒã‚¯ä½¿ç”¨)</p>

<div class="panel">
  ãƒ«ãƒ¼ãƒ : <input id="roomId" value="" placeholder="room123456" />
  åå‰: <input id="name" value="Guest" placeholder="ã‚ãªãŸã®åå‰" />
  <button id="joinBtn">å…¥å®¤</button>
  <button id="startBtn">é–‹å§‹(æŠ•ç¥¨)</button>
  <button id="restartBtn" style="display:none;">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ(æŠ•ç¥¨)</button>
  <div id="info" class="muted" style="margin-top:8px;"></div>
</div>

<div id="deckInfo" class="muted"></div>
<div id="gameArea"></div>

<div id="scoreBoard" class="scoreboard"></div>
<div id="gameOverPane"></div>

<!-- RON ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="ronModal">
  <div id="ronBox">
    <h3>ğŸ€„ ãƒ­ãƒ³å¯èƒ½ï¼</h3>
    <div id="ronMsg" class="muted" style="margin:8px 0 12px"></div>
    <div id="ronCard" style="margin:12px 0;"></div>
    <div id="ronMyHand" style="margin:12px 0;"></div>
    <div id="ronCalc" style="margin:12px 0; font-size:14px; color:#ffd166;"></div>
    <div id="ronTimer" class="muted" style="margin:12px 0; font-size: 24px; font-weight: bold;"></div>
    <div>
      <button id="ronYes" style="background: linear-gradient(145deg, #dc2626, #ef4444); font-size: 18px; padding: 14px 28px;">ğŸ€„ ãƒ­ãƒ³ã™ã‚‹</button>
      <button id="ronNo" style="font-size: 16px; padding: 12px 24px;">ç¶šè¡Œã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- çµ‚å±€ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="resultOverlay">
  <div id="thunderFX"></div>
  <div id="resultCard">
    <div id="resultTitle">ãƒ„ãƒ¢</div>
    <div id="resultSub"></div>
    <div id="resultTable"></div>
    <div><button id="resultClose">é–‰ã˜ã‚‹</button></div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
(() => {
  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDç®¡ç†
  const LS_KEY_ID = "fe_client_id_v1";
  let clientId = localStorage.getItem(LS_KEY_ID);
  if (!clientId) {
    clientId = crypto.randomUUID ? crypto.randomUUID() : 'c_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
    localStorage.setItem(LS_KEY_ID, clientId);
  }
  window.FE_CLIENT_ID = clientId;

  const socket = io();

  const roomIdInput = document.getElementById("roomId");
  const nameInput = document.getElementById("name");
  const joinBtn = document.getElementById("joinBtn");
  const startBtn = document.getElementById("startBtn");
  const restartBtn = document.getElementById("restartBtn");

  function genDefaultRoomId() {
    return 'room' + (100000 + Math.floor(Math.random() * 900000));
  }

  if (!roomIdInput.value) {
    roomIdInput.value = genDefaultRoomId();
  }

  let state = null, myHand = [], mySeat = null, roomId = null;
  let lastGame = null;
  let freezeActive = false;

  socket.on("freeze", ({active}) => { freezeActive = !!active; });

  socket.on("connect", () => {
    const saved = localStorage.getItem('fe_last_session');
    const cid = window.FE_CLIENT_ID || null;
    if (saved) {
      try {
        const { roomId: rid, name } = JSON.parse(saved) || {};
        socket.emit("joinRoom", { roomId: rid || "", name: name || "", clientId: cid });
        return;
      } catch (_) {}
    }
    socket.emit("joinRoom", { roomId: "", name: "", clientId: cid });
  });

  joinBtn.onclick = () => {
    if (freezeActive) return;
    const typed = (roomIdInput.value || '').trim();
    const rid = typed || genDefaultRoomId();
    const name = (nameInput.value || 'Guest').trim();
    roomId = rid;
    socket.emit('joinRoom', { roomId: rid, name, clientId: window.FE_CLIENT_ID || null });
    roomIdInput.value = rid;
  };

  socket.on("you", ({ seat, name, roomId: rid }) => {
    mySeat = seat;
    roomId = rid;
    roomIdInput.value = rid;
    localStorage.setItem('fe_last_session', JSON.stringify({ roomId: rid, name: name || '' }));
  });

  startBtn.onclick = () => {
    if (!roomId || freezeActive) return;
    startBtn.disabled = true;
    socket.emit("requestStart", { roomId });
  };

  restartBtn.onclick = () => {
    if (!roomId || freezeActive) return;
    restartBtn.disabled = true;
    socket.emit("requestRestart", { roomId });
  };

  const suitClass = s => (s === "â™¥" || s === "â™¦") ? "suit-red" : "suit-black";

  function seatName(seat) {
    const p = (state?.players || []).find(x => x.seat === seat);
    return p ? (p.name || `Player${p.seat}`) : `Player${seat}`;
  }

  // ã‚«ãƒ¼ãƒ‰ã®ç‰¹æ®ŠåŠ¹æœã‚¯ãƒ©ã‚¹ã‚’å–å¾—
  function getCardSpecialClass(card) {
    const rank = card.replace(/[â™ â™¥â™¦â™£]/g, "");
    const suit = (card.match(/[â™ â™¥â™¦â™£]/) || [""])[0];
    
    if (rank === '2') return 'special-2';
    if (rank === 'Q' && suit === 'â™ ') return 'special-qs';
    if (rank === '5' || rank === '7') return 'special-57';
    if (rank === '8') return 'special-8';
    return '';
  }

  function cardSpan(card, isField = false) {
    const r = card.replace(/[â™ â™¥â™¦â™£]/g, "");
    const s = (card.match(/[â™ â™¥â™¦â™£]/) || [""])[0];
    const colorClass = (s === "â™¥" || s === "â™¦") ? "suit-red" : "suit-black";
    const baseClass = isField ? "field-card" : "card";
    const specialClass = getCardSpecialClass(card);
    return `<span class="${baseClass} ${colorClass} ${specialClass}">${r}${s}</span>`;
  }

  function cardSpanPlayable(card, idx, can) {
    const r = card.replace(/[â™ â™¥â™¦â™£]/g, "");
    const s = (card.match(/[â™ â™¥â™¦â™£]/) || [""])[0];
    const colorClass = (s === "â™¥" || s === "â™¦") ? "suit-red" : "suit-black";
    const specialClass = getCardSpecialClass(card);
    const cls = can ? `card ${colorClass} ${specialClass} puttable` : `card ${colorClass} ${specialClass}`;
    return `<span class="${cls}" data-idx="${idx}">${r}${s}</span>`;
  }

  // ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰æç”»
  function renderScoreBoard(players, totals, round) {
    if (!players) return;
    const bySeat = [...players].sort((a, b) => a.seat - b.seat);
    const rows = bySeat.map(p => ({
      seat: p.seat,
      name: p.name || `Player${p.seat}`,
      total: totals?.[p.seat - 1] ?? 0,
      delta: round?.[p.seat - 1] ?? 0
    })).sort((a, b) => b.total - a.total);

    let rank = 1;
    const now = new Date();
    const timeStr = now.toLocaleString("ja-JP", {
      month: "2-digit", day: "2-digit",
      hour: "2-digit", minute: "2-digit", second: "2-digit"
    });

    let html = `
      <div style="margin:4px 0 10px;">
        <b>ãƒ«ãƒ¼ãƒ :</b> ${state?.roomId ?? '-'}
        <span style="font-size:0.9em;opacity:0.7;margin-left:10px;">(${timeStr})</span>
      </div>
      <b style="font-size:18px;">ç·åˆã‚¹ã‚³ã‚¢</b><br>
      <table class="ranktable">
        <tr><th>é †ä½</th><th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</th><th>ä»Šå›</th><th>åˆè¨ˆ</th></tr>`;

    rows.forEach((r, idx) => {
      if (idx > 0 && r.total < rows[idx - 1].total) rank = idx + 1;
      const delta = r.delta === 0 ? "Â±0" : (r.delta > 0 ? `+${Math.round(r.delta)}` : `${Math.round(r.delta)}`);
      const deltaColor = r.delta > 0 ? 'color:#4ade80;' : (r.delta < 0 ? 'color:#f87171;' : '');
      html += `<tr><td>${rank}</td><td>${r.name}</td><td style="${deltaColor}">${delta}</td><td>${Math.round(r.total)}</td></tr>`;
    });

    html += "</table>";
    document.getElementById("scoreBoard").innerHTML = html;
  }

  function renderGameOverPane() {
    const pane = document.getElementById("gameOverPane");
    if (!lastGame) { pane.innerHTML = ""; return; }

    const reason = lastGame.reason;
    let winnerLine = "";
    
    if (reason === 'å±±æœ­åˆ‡ã‚Œ') {
      winnerLine = "å‹è€…ãªã—";
    } else if (lastGame.winnerSeat) {
      winnerLine = `Winner: ${seatName(lastGame.winnerSeat)}`;
    }

    let html = `<div class="winner"><b>Game Over</b> : ${reason} / ${winnerLine}</div>`;
    
    if (lastGame.scores && lastGame.scores.length) {
      html += `<div class="panel"><b>å¾—ç‚¹å†…è¨³</b><br>`;
      html += lastGame.scores.map(s => `${seatName(s.fromSeat + 1)} â†’ ${seatName(s.toSeat + 1)} : ${s.amount} ç‚¹ (${s.reason})`).join("<br>");
      html += `</div>`;
    }
    
    // ç‚¹æ•°è¨ˆç®—è©³ç´°
    if (lastGame.pointBreakdown) {
      const pb = lastGame.pointBreakdown;
      html += `<div class="panel point-breakdown">
        <b>è¨ˆç®—è©³ç´°</b><br>
        <span class="formula">
          æ”¾éŠƒè€…æ‰‹æœ­(${pb.loserHand}) + å‡ºæœ­(${pb.playedCard}) + ãƒ­ãƒ³è€…æ‰‹æœ­(${pb.ronnerHand}) = ${pb.base}<br>
          ${pb.base} Ã— ${pb.multiplier} = <b>${pb.total}ç‚¹</b>
        </span>
      </div>`;
    }
    
    if (lastGame.reveals && lastGame.reveals.length) {
      html += `<div class="reveal"><h3>æ‰‹æœ­é–‹ç¤º</h3>`;
      lastGame.reveals.forEach(r => {
        let label = r.role === "tsumo_winner" ? `${seatName(r.seat)}ï¼ˆãƒ„ãƒ¢å‹è€…ï¼‰` :
                    r.role === "ron_winner" ? `${seatName(r.seat)}ï¼ˆãƒ­ãƒ³å‹è€…ï¼‰` :
                    r.role === "ron_gaeshi_winner" ? `${seatName(r.seat)}ï¼ˆãƒ­ãƒ³è¿”ã—å‹è€…ï¼‰` :
                    r.role === "ron_gaeshi_loser" ? `${seatName(r.seat)}ï¼ˆãƒ­ãƒ³è¿”ã—æ•—è€…ï¼‰` :
                    r.role === "loser" ? `${seatName(r.seat)}ï¼ˆæ•—è€…ï¼‰` :
                    `${seatName(r.seat)}`;
        html += `<div class="row"><b>${label}</b><div>${(r.hand || []).map(c => cardSpan(c)).join("")}</div></div>`;
      });
      html += `</div>`;
    }
    pane.innerHTML = html;
  }

  // çµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
  const resultOverlay = document.getElementById("resultOverlay");
  const resultTitle = document.getElementById("resultTitle");
  const resultSub = document.getElementById("resultSub");
  const resultTable = document.getElementById("resultTable");
  const resultClose = document.getElementById("resultClose");

  function showResultOverlay(payload) {
    const reason = payload.reason;
    const titleEl = document.getElementById("resultTitle");
    const thunder = document.getElementById("thunderFX");

    titleEl.classList.remove("title-tsumo", "title-ron", "title-ronrev", "title-draw");
    thunder.style.display = "none";
    thunder.innerHTML = "";

    if (reason === 'ãƒ„ãƒ¢') {
      titleEl.textContent = "ãƒ„ãƒ¢";
      titleEl.classList.add("title-tsumo");
    } else if (reason === 'ãƒ­ãƒ³è¿”ã—') {
      titleEl.innerHTML = "ãƒ­ãƒ³è¿”ã—<br>ç™ºç”Ÿï¼ï¼";
      titleEl.classList.add("title-ronrev");
      thunder.style.display = "block";
      thunder.innerHTML = `
        <div class="thunder-flash"></div>
        <div class="bolt b1" style="--r:-6deg;"></div>
        <div class="bolt b2" style="--r:5deg;"></div>
      `;
    } else if (reason === 'ãƒ­ãƒ³') {
      titleEl.textContent = "ãƒ­ãƒ³";
      titleEl.classList.add("title-ron");
    } else if (reason === 'å±±æœ­åˆ‡ã‚Œ') {
      titleEl.textContent = "å±±æœ­åˆ‡ã‚Œ";
      titleEl.classList.add("title-draw");
    }

    let winnerLine = "";
    if (reason === 'å±±æœ­åˆ‡ã‚Œ') {
      winnerLine = "å‹è€…ãªã— - å¼•ãåˆ†ã‘";
    } else if (payload.winnerSeat) {
      winnerLine = `Winner: ${seatName(payload.winnerSeat)}`;
    }
    resultSub.textContent = winnerLine;

    let html = "";
    if (payload.scores && payload.scores.length) {
      html += `<h3>å¾—ç‚¹ç§»å‹•</h3>`;
      html += payload.scores.map(s => `<div>${seatName(s.fromSeat + 1)} â†’ ${seatName(s.toSeat + 1)} : <b>${s.amount}ç‚¹</b> (${s.reason})</div>`).join("");
    }
    
    // ç‚¹æ•°è¨ˆç®—è©³ç´°
    if (payload.pointBreakdown) {
      const pb = payload.pointBreakdown;
      html += `<div class="point-breakdown">
        <b>è¨ˆç®—å¼</b><br>
        æ”¾éŠƒè€…æ‰‹æœ­(${pb.loserHand}) + å‡ºæœ­(${pb.playedCard}) + ãƒ­ãƒ³è€…æ‰‹æœ­(${pb.ronnerHand}) = ${pb.base}<br>
        <span class="formula">${pb.base} Ã— ${pb.multiplier}å€ = <b>${pb.total}ç‚¹</b></span>
      </div>`;
    }
    
    if (payload.reveals && payload.reveals.length) {
      html += `<h3 style="margin-top:12px">æ‰‹æœ­é–‹ç¤º</h3>`;
      html += payload.reveals.map(r => {
        let label = r.role === "tsumo_winner" ? `${seatName(r.seat)}ï¼ˆãƒ„ãƒ¢å‹è€…ï¼‰` :
                    r.role === "ron_winner" ? `${seatName(r.seat)}ï¼ˆãƒ­ãƒ³å‹è€…ï¼‰` :
                    r.role === "ron_gaeshi_winner" ? `${seatName(r.seat)}ï¼ˆãƒ­ãƒ³è¿”ã—å‹è€…ï¼‰` :
                    r.role === "ron_gaeshi_loser" ? `${seatName(r.seat)}ï¼ˆãƒ­ãƒ³è¿”ã—æ•—è€…ï¼‰` :
                    r.role === "loser" ? `${seatName(r.seat)}ï¼ˆæ•—è€…ï¼‰` :
                    `${seatName(r.seat)}`;
        return `<div style="margin:8px 0;"><b>${label}</b><div>${(r.hand || []).map(c => cardSpan(c)).join("")}</div></div>`;
      }).join("");
    }
    resultTable.innerHTML = html || "<div class='muted'>ï¼ˆæƒ…å ±ãªã—ï¼‰</div>";
    resultOverlay.style.display = "flex";
  }

  resultClose.onclick = () => { resultOverlay.style.display = "none"; };

  // ãƒ¡ã‚¤ãƒ³æç”»
  function render() {
    if (!state) return;

    document.getElementById("info").textContent =
      `${state.roomId} / ${state.started ? (state.finished ? "çµ‚äº†" : "ãƒ—ãƒ¬ã‚¤ä¸­") : "å¾…æ©Ÿä¸­"} / å‚åŠ è€…:${(state.players || []).length}`;
    document.getElementById("deckInfo").textContent = `å±±æœ­: ${state.deckCount ?? 0} æš (2ãƒ‡ãƒƒã‚¯)`;

    if (state.start?.awaiting) {
      startBtn.disabled = false;
      startBtn.textContent = `é–‹å§‹(æŠ•ç¥¨) Ready ${state.start.voteCount}/${state.start.total}`;
    } else {
      startBtn.textContent = "é–‹å§‹(æŠ•ç¥¨)";
      startBtn.disabled = !!state.started;
    }

    if (state.finished && state.restart?.awaiting) {
      restartBtn.style.display = "inline-block";
      restartBtn.disabled = false;
      restartBtn.textContent = `ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ(æŠ•ç¥¨) Ready ${state.restart.voteCount}/${state.restart.total}`;
    } else {
      restartBtn.style.display = "none";
    }

    // å ´ã®ã‚«ãƒ¼ãƒ‰
    let html = `<div class="panel"><b>å ´:</b> ${state.discardTop ? cardSpan(state.discardTop, true) : "(ãªã—)"}`;
    
    // æ”»æ’ƒçŠ¶æ…‹è¡¨ç¤º
    if (state.attackState && state.attackState.active) {
      const attackClass = state.attackState.type === 'Qâ™ ' ? 'attack-field qs-attack' : 'attack-field';
      html += `<span class="${attackClass}">âš¡ æ”»æ’ƒä¸­ ${state.attackState.type} Ã—${state.attackState.totalDraw}æšï¼</span>`;
    }
    
    if (state.requiredSuit) html += `<span style="color:#ffd166;font-weight:bold;margin-left:12px;">æŒ‡å®šãƒãƒ¼ã‚¯: ${state.requiredSuit}</span>`;
    html += `</div>`;

    // ãƒãƒ¼ã‚¯é¸æŠ
    if (state.pendingSuitChooser && mySeat === state.pendingSuitChooser) {
      html += `<div class="suit-select"><p><strong>8 ã®ãƒãƒ¼ã‚¯ã‚’é¸æŠï¼š</strong></p>
        <button class="suit-btn black" onclick="chooseSuit('â™ ')">â™ </button>
        <button class="suit-btn red" onclick="chooseSuit('â™¥')">â™¥</button>
        <button class="suit-btn red" onclick="chooseSuit('â™¦')">â™¦</button>
        <button class="suit-btn black" onclick="chooseSuit('â™£')">â™£</button>
      </div>`;
    }

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«
    html += (state.players || []).map(p => {
      const isMyTurn = p.seat === mySeat && p.isTurn;
      const hot = p.isTurn ? " turn-hot" : "";
      const display = p.name || `Player${p.seat}`;

      if (p.seat === mySeat) {
        const cards = myHand.length
          ? myHand.map((c, i) => cardSpanPlayable(c, i, false)).join("")
          : `<span class="card-back">ï¼ˆæ‰‹æœ­ãªã—ï¼‰</span>`;

        return `<div class="panel${hot}" id="panel-seat-${p.seat}">
          <div class="turn-banner ${isMyTurn ? 'active' : ''}">ğŸ¯ ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ï¼</div>
          <b style="font-size:18px;">${display} (You)</b>
          <br>
          <div id="my-hand" style="margin:12px 0;">${cards}</div>
          <div style="margin-top:10px;">
            <button id="drawBtn" style="padding:12px 24px;font-size:16px;">ğŸƒ ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã</button>
          </div>
        </div>`;
      } else {
        return `<div class="panel${hot}">
          <b style="font-size:16px;">${display}</b>
          <span class="opponent-turn-indicator ${p.isTurn ? 'active' : ''}">æ€è€ƒä¸­...</span>
          <br>
          <span class="card-back" style="margin-top:8px;display:inline-block;">Ã—${p.handCount}</span>
        </div>`;
      }
    }).join("");

    document.getElementById("gameArea").innerHTML = html;

    // Draw ãƒœã‚¿ãƒ³è¨­å®š
    const me = (state.players || []).find(pp => pp.seat === mySeat);
    const myTurn = !!(me && me.isTurn);
    const drawBtn = document.getElementById("drawBtn");
    if (drawBtn) {
      // æ”»æ’ƒä¸­ã¯ã€Œå¼•ãã€ã§æ”»æ’ƒãƒ‰ãƒ­ãƒ¼
      if (state.attackState && state.attackState.active && myTurn) {
        drawBtn.textContent = `âš¡ ${state.attackState.totalDraw}æšå¼•ã`;
        drawBtn.style.background = 'linear-gradient(145deg, #dc2626, #ef4444)';
      } else {
        drawBtn.textContent = 'ğŸƒ ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã';
        drawBtn.style.background = '';
      }
      
      drawBtn.onclick = () => {
        if (freezeActive) return;
        roomId && socket.emit("move", { roomId, move: { type: "draw" } });
      };
      drawBtn.disabled = !myTurn || state.finished || !!state.pendingSuitChooser;
    }

    renderScoreBoard(state.players, state.sessionScores, state.lastRoundScores);
    renderGameOverPane();
  }

  // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯
  document.addEventListener("click", (ev) => {
    const cont = document.querySelector("#my-hand");
    if (!cont) return;
    const el = ev.target.closest(".card.puttable[data-idx]");
    if (!el || !cont.contains(el)) return;
    if (freezeActive) return;
    const idx = Number(el.dataset.idx);
    if (Number.isInteger(idx) && roomId) {
      socket.emit("move", { roomId, move: { type: "play", index: idx } });
    }
  });

  socket.on("state", (s) => { state = s; render(); });
  socket.on("hand", ({ hand }) => { myHand = hand || []; render(); });
  socket.on("playHints", ({ puttableIdx, canDraw, mustChoose }) => {
    document.querySelectorAll("#my-hand .card").forEach((el, idx) => {
      el.dataset.idx = idx;
      if (puttableIdx.includes(idx)) el.classList.add("puttable");
      else el.classList.remove("puttable");
    });
    const drawBtn = document.getElementById("drawBtn");
    if (drawBtn) drawBtn.disabled = !canDraw || mustChoose || state?.finished;
  });

  // RON ãƒ¢ãƒ¼ãƒ€ãƒ«
  const ronModal = document.getElementById("ronModal");
  const ronMsg = document.getElementById("ronMsg");
  const ronCard = document.getElementById("ronCard");
  const ronTimer = document.getElementById("ronTimer");
  const ronYes = document.getElementById("ronYes");
  const ronNo = document.getElementById("ronNo");
  const ronMyHand = document.getElementById("ronMyHand");
  const ronCalc = document.getElementById("ronCalc");
  let ronPending = null;
  let ronTickId = null;

  socket.on("ronOffer", ({ card, loserSeat, yourSeat, deadline }) => {
    ronPending = { card, loserSeat, deadline: Number(deadline) || (Date.now() + 5000) };
    const who = (state?.players || []).find(p => p.seat === yourSeat)?.name || `Player${yourSeat}`;
    const loser = (state?.players || []).find(p => p.seat === loserSeat)?.name || `Player${loserSeat}`;
    
    // ã‚«ãƒ¼ãƒ‰ã®æ•°å­—
    const cardRank = card.replace(/[â™ â™¥â™¦â™£]/g, "");
    let cardValue = cardRank === 'A' ? 1 : cardRank === 'J' ? 11 : cardRank === 'Q' ? 12 : cardRank === 'K' ? 13 : parseInt(cardRank, 10);
    
    ronMsg.innerHTML = `<b>${loser}</b> ãŒå‡ºã—ãŸã‚«ãƒ¼ãƒ‰ã®æ•°å­— <b>${cardValue}</b> ã¨<br>ã‚ãªãŸã®æ‰‹æœ­åˆè¨ˆãŒä¸€è‡´ã—ã¦ã„ã¾ã™ï¼`;
    ronCard.innerHTML = `<div style="margin:8px 0;">å‡ºã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰:</div>${cardSpan(card, true)}`;
    ronMyHand.innerHTML = `<b>ã‚ãªãŸã®æ‰‹æœ­ï¼š</b><br>${(myHand || []).map(c => cardSpan(c)).join(" ") || "(ãªã—)"}`;
    ronCalc.innerHTML = `ãƒ­ãƒ³æˆç«‹ã§<b>Ã—2å€</b>ã®ç‚¹æ•°ã‚’ç²å¾—ï¼<br><small>â€»ãƒ­ãƒ³è¿”ã—ã•ã‚Œã‚‹ã¨Ã—4å€ã‚’æ”¯æ‰•ã„ã¾ã™</small>`;
    ronModal.style.display = "flex";

    if (ronTickId) clearInterval(ronTickId);
    const tick = () => {
      const remain = Math.max(0, ronPending.deadline - Date.now());
      const sec = Math.ceil(remain / 1000);
      ronTimer.textContent = `â± æ®‹ã‚Š ${sec} ç§’`;
      if (remain <= 0) {
        socket.emit("move", { roomId, move: { type: "noRon" } });
        closeRon();
      }
    };
    tick();
    ronTickId = setInterval(tick, 250);
  });

  function closeRon() {
    if (ronTickId) { clearInterval(ronTickId); ronTickId = null; }
    ronPending = null;
    ronModal.style.display = "none";
    ronTimer.textContent = "";
    ronCard.innerHTML = "";
  }

  ronYes.onclick = () => {
    if (!ronPending) return;
    socket.emit("move", { roomId, move: { type: "ron" } });
    closeRon();
  };
  ronNo.onclick = () => {
    if (!ronPending) return;
    socket.emit("move", { roomId, move: { type: "noRon" } });
    closeRon();
  };

  socket.on("gameOver", (payload) => {
    lastGame = payload;
    renderGameOverPane();
    renderScoreBoard(state?.players, payload.sessionScores, payload.lastRoundScores);
    showResultOverlay(payload);
  });

  window.chooseSuit = suit => {
    if (freezeActive) return;
    roomId && socket.emit("move", { roomId, move: { type: "chooseSuit", suit } });
  };
})();
</script>
</body>
</html>
